<!doctype html><html lang="ko"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>밤실 부녀 화담숲 여행 모임</title>
<link rel="stylesheet" href="assets/css/style.css"></head><body>
<header class="header"><div class="header-inner">
  <div class="brand"><div class="title">밤실 부녀 화담숲 여행 모임</div><span class="badge">모바일</span></div>
</div></header>
<!-- ✅ 메인 이미지 슬라이드 영역 -->
<section id="heroFx" class="hero"></section>
<main class="container">
  <section class="section"><div class="card"><div id="heroFx" class="hero-fixed"></div></div></section>
  <section class="section"><h2>📌 공지사항</h2><div id="annList" class="list"></div></section>
  <section class="section"><h2>🗳️ 설문</h2><div id="pollWrap"></div></section>
  <section class="section"><h2>📍 집합 장소</h2>
    <div class="card"><div id="meetAddr" style="font-weight:700"></div><div class="small">아래 지도 또는 아이콘을 이용하세요.</div></div>
    <div id="mapBox" class="section"></div>
  </section>
</main>
<nav class="navbar"><div class="navbar-inner">
  <a href="index.html">홈</a><a href="schedule.html">일정</a><a href="visits.html">방문지</a><a href="survey.html">설문</a><a href="admin.html">관리자</a>
</div></nav>
<script type="module">
import { supabase } from './assets/js/supabase.js';
import { qs, qsa, linkify, mapLinks, mountCarousel } from './assets/js/ui.js';

async function loadHero(){
  const { data, error } = await supabase.from('home_slides').select('*').order('sort',{ascending:true}).order('created_at',{ascending:false});
  const box=qs('#heroFx');
  if(error){ console.error(error); }
  if(!data || !data.length){
    box.innerHTML = '<div class="slide"><img src="assets/images/cover.svg" alt=""></div>';
    return;
  }
  box.innerHTML = data.map(s=>`<div class="slide"><img src="${s.url}" alt=""></div>`).join('');
  mountCarousel(box, 2800);
}

async function loadAnnouncements(){
  const { data } = await supabase.from('notices').select('*').order('created_at',{ascending:false}).limit(10);
  qs('#annList').innerHTML = (data||[]).map(n=>`<div class="card">
    <div class="kv"><div><b>${n.title||''}</b></div><div class="small">${new Date(n.created_at).toLocaleDateString()}</div></div>
    <div class="small">${linkify(n.body||'')}</div>
  </div>`).join('') || '<div class="card small">등록된 공지사항이 없습니다.</div>';
}

async function loadPolls(){
  const { data: polls } = await supabase.from('polls').select('*').eq('is_active', true).order('created_at',{ascending:false}).limit(1);
  const wrap=qs('#pollWrap'); wrap.innerHTML='';
  if(!polls || !polls.length){ wrap.innerHTML='<div class="card small">진행중인 설문이 없습니다.</div>'; return; }
  const p = polls[0];
  const { data: opts } = await supabase.from('poll_options').select('*').eq('poll_id', p.id).order('id',{ascending:true});
  const multiple = !!p.multiple;
 const optsHtml = (opts||[]).map(o=>`
  <label class="opt">
    <input type="${multiple?'checkbox':'radio'}" name="poll_${p.id}" value="${o.id}"> ${o.option_text||o.label||''}
  </label>`).join('');
  const el=document.createElement('div'); el.className='card';
  el.innerHTML = `<div style="font-weight:700">${p.question}</div>${p.deadline?`<div class="small">마감: ${p.deadline}</div>`:''}
    <div style="margin-top:6px">${optsHtml}</div><div class="action-row"><button class="btn" data-vote="${p.id}">투표하기</button></div>`;
  wrap.appendChild(el);
  wrap.onclick = async (e)=>{
    const b = e.target.closest('[data-vote]'); if(!b) return;
    // ID는 문자열 그대로 사용 (UUID / BigInt 모두 호환)
    const pid = b.getAttribute('data-vote');

    // 동일한 name을 가진 라디오/체크박스에서 선택 항목 수집
    const inputs = qsa(`input[name="poll_${pid}"]`, wrap);
    const sel = inputs.filter(i => i.checked).map(i => Number(i.value) || i.value);

    // 실제 선택이 없는 경우만 경고  
    if (!sel.length) { alert('항목을 선택하세요.'); return; }
    try{
      const { error } = await supabase.rpc('poll_vote', { p_poll: pid, p_option_ids: sel });
      if(error) throw error;
    }catch(_){
      const rows = sel.map(oid=>({ poll_id: pid, option_id: oid }));
      const { error } = await supabase.from('poll_responses').insert(rows);
      if(error) return alert('투표 오류: '+error.message);
    }
    alert('투표되었습니다. 결과는 관리자 페이지에서 확인하세요.');
  };
}

async function loadMeeting(){
  const res = await supabase.from('settings').select('value').eq('key','meeting').maybeSingle();
  const v = res.data?.value || null; const q = v?.query || v?.address || '';
  qs('#meetAddr').textContent = v?.address || v?.query || '(미설정)';
  const urls = mapLinks(q); const embed=v?.embed_url;
 // ✅ 자동 구글 지도 iframe 생성
const googleEmbed = `https://www.google.com/maps?q=${encodeURIComponent(q)}&output=embed`;

qs('#mapBox').innerHTML = `
  <div class="card">
    <div class="action-row map-btns">
      <a class="map-btn g" href="${urls.g}" target="_blank" title="Google 지도">Google</a>
      <a class="map-btn n" href="${urls.n}" target="_blank" title="Naver 지도">Naver</a>
      <a class="map-btn k" href="${urls.k}" target="_blank" title="Kakao 지도">Kakao</a>
    </div>
    <iframe
      src="${embed || googleEmbed}"
      style="width:100%;height:240px;border:0;border-radius:12px"
      allowfullscreen=""
      loading="lazy"
      referrerpolicy="no-referrer-when-downgrade">
    </iframe>
  </div>`;
}

loadHero(); loadAnnouncements(); loadPolls(); loadMeeting();
</script>
</body></html>

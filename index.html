<!doctype html><html lang="ko"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>ë°¤ì‹¤ ë¶€ë…€ í™”ë‹´ìˆ² ì—¬í–‰ ëª¨ì„</title>
<link rel="stylesheet" href="assets/css/style.css"></head><body>
<header class="header"><div class="header-inner">
  <div class="brand"><div class="title">ë°¤ì‹¤ ë¶€ë…€ í™”ë‹´ìˆ² ì—¬í–‰ ëª¨ì„</div><span class="badge">ëª¨ë°”ì¼</span></div>
</div></header>
<!-- âœ… ë©”ì¸ ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë“œ ì˜ì—­ -->
<section id="heroFx" class="hero"></section>
<main class="container">
  <section class="section"><div class="card"><div id="heroFx" class="hero-fixed"></div></div></section>
  <section class="section"><h2>ğŸ“Œ ê³µì§€ì‚¬í•­</h2><div id="annList" class="list"></div></section>
  <section class="section"><h2>ğŸ—³ï¸ ì„¤ë¬¸</h2><div id="pollWrap"></div></section>
  <section class="section"><h2>ğŸ“ ì§‘í•© ì¥ì†Œ</h2>
    <div class="card"><div id="meetAddr" style="font-weight:700"></div><div class="small">ì•„ë˜ ì§€ë„ ë˜ëŠ” ì•„ì´ì½˜ì„ ì´ìš©í•˜ì„¸ìš”.</div></div>
    <div id="mapBox" class="section"></div>
  </section>
</main>
<nav class="navbar"><div class="navbar-inner">
  <a href="index.html">í™ˆ</a><a href="schedule.html">ì¼ì •</a><a href="visits.html">ë°©ë¬¸ì§€</a><a href="survey.html">ì„¤ë¬¸</a><a href="admin.html">ê´€ë¦¬ì</a>
</div></nav>
<script type="module">
import { supabase } from './assets/js/supabase.js';
import { qs, qsa, linkify, mapLinks, mountCarousel } from './assets/js/ui.js';

async function loadHero(){
  const { data, error } = await supabase.from('home_slides').select('*').order('sort',{ascending:true}).order('created_at',{ascending:false});
  const box=qs('#heroFx');
  if(error){ console.error(error); }
  if(!data || !data.length){
    box.innerHTML = '<div class="slide"><img src="assets/images/cover.svg" alt=""></div>';
    return;
  }
  box.innerHTML = data.map(s=>`<div class="slide"><img src="${s.url}" alt=""></div>`).join('');
  mountCarousel(box, 2800);
}

async function loadAnnouncements(){
  const { data } = await supabase.from('notices').select('*').order('created_at',{ascending:false}).limit(10);
  qs('#annList').innerHTML = (data||[]).map(n=>`<div class="card">
    <div class="kv"><div><b>${n.title||''}</b></div><div class="small">${new Date(n.created_at).toLocaleDateString()}</div></div>
    <div class="small">${linkify(n.body||'')}</div>
  </div>`).join('') || '<div class="card small">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
}

async function loadPolls(){
  const { data: polls } = await supabase.from('polls').select('*').eq('is_active', true).order('created_at',{ascending:false}).limit(1);
  const wrap=qs('#pollWrap'); wrap.innerHTML='';
  if(!polls || !polls.length){ wrap.innerHTML='<div class="card small">ì§„í–‰ì¤‘ì¸ ì„¤ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  const p = polls[0];
  const { data: opts } = await supabase.from('poll_options').select('*').eq('poll_id', p.id).order('id',{ascending:true});
  const multiple = !!p.multiple;
 const optsHtml = (opts||[]).map(o=>`
  <label class="opt">
    <input type="${multiple?'checkbox':'radio'}" name="poll_${p.id}" value="${o.id}"> ${o.option_text||o.label||''}
  </label>`).join('');
  const el=document.createElement('div'); el.className='card';
  el.innerHTML = `<div style="font-weight:700">${p.question}</div>${p.deadline?`<div class="small">ë§ˆê°: ${p.deadline}</div>`:''}
    <div style="margin-top:6px">${optsHtml}</div><div class="action-row"><button class="btn" data-vote="${p.id}">íˆ¬í‘œí•˜ê¸°</button></div>`;
  wrap.appendChild(el);
  wrap.onclick = async (e)=>{
    const b = e.target.closest('[data-vote]'); if(!b) return;
    // IDëŠ” ë¬¸ìì—´ ê·¸ëŒ€ë¡œ ì‚¬ìš© (UUID / BigInt ëª¨ë‘ í˜¸í™˜)
    const pid = b.getAttribute('data-vote');

    // ë™ì¼í•œ nameì„ ê°€ì§„ ë¼ë””ì˜¤/ì²´í¬ë°•ìŠ¤ì—ì„œ ì„ íƒ í•­ëª© ìˆ˜ì§‘
    const inputs = qsa(`input[name="poll_${pid}"]`, wrap);
    const sel = inputs.filter(i => i.checked).map(i => Number(i.value) || i.value);

    // ì‹¤ì œ ì„ íƒì´ ì—†ëŠ” ê²½ìš°ë§Œ ê²½ê³   
    if (!sel.length) { alert('í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
    try{
      const { error } = await supabase.rpc('poll_vote', { p_poll: pid, p_option_ids: sel });
      if(error) throw error;
    }catch(_){
      const rows = sel.map(oid=>({ poll_id: pid, option_id: oid }));
      const { error } = await supabase.from('poll_responses').insert(rows);
      if(error) return alert('íˆ¬í‘œ ì˜¤ë¥˜: '+error.message);
    }
    alert('íˆ¬í‘œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì„¸ìš”.');
  };
}

async function loadMeeting(){
  const res = await supabase.from('settings').select('value').eq('key','meeting').maybeSingle();
  const v = res.data?.value || null; const q = v?.query || v?.address || '';
  qs('#meetAddr').textContent = v?.address || v?.query || '(ë¯¸ì„¤ì •)';
  const urls = mapLinks(q); const embed=v?.embed_url;
 // âœ… ìë™ êµ¬ê¸€ ì§€ë„ iframe ìƒì„±
const googleEmbed = `https://www.google.com/maps?q=${encodeURIComponent(q)}&output=embed`;

qs('#mapBox').innerHTML = `
  <div class="card">
    <div class="action-row map-btns">
      <a class="map-btn g" href="${urls.g}" target="_blank" title="Google ì§€ë„">Google</a>
      <a class="map-btn n" href="${urls.n}" target="_blank" title="Naver ì§€ë„">Naver</a>
      <a class="map-btn k" href="${urls.k}" target="_blank" title="Kakao ì§€ë„">Kakao</a>
    </div>
    <iframe
      src="${embed || googleEmbed}"
      style="width:100%;height:240px;border:0;border-radius:12px"
      allowfullscreen=""
      loading="lazy"
      referrerpolicy="no-referrer-when-downgrade">
    </iframe>
  </div>`;
}

loadHero(); loadAnnouncements(); loadPolls(); loadMeeting();
</script>
</body></html>

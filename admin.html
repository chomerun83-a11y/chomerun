<!doctype html><html lang="ko"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>ê´€ë¦¬ì</title>
<link rel="stylesheet" href="assets/css/style.css"></head><body>
<header class="header"><div class="header-inner"><div class="brand"><div class="title">ğŸ› ï¸ ê´€ë¦¬ì</div></div></div></header>
<main class="container">
  <section id="loginView" class="section login-card card">
    <h2 style="margin:0 0 6px 0;">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
    <form id="loginForm" class="action-row" autocomplete="on">
      <input id="email" class="input" placeholder="ì´ë©”ì¼" autocomplete="username" required>
      <input id="pw" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" required>
      <button class="btn" type="submit">ë¡œê·¸ì¸</button>
    </form>
    <div class="small">* ë¡œê·¸ì¸ í›„ì—ë§Œ ê´€ë¦¬ ê¸°ëŠ¥ì´ ë³´ì…ë‹ˆë‹¤.</div>
    <div id="loginError" class="small" style="color:#b42318"></div>
  </section>

  <section id="adminApp" class="section" style="display:none;">
    <div class="admin-wrap">
      <aside class="sidebar">
        <a href="#" class="side-item" data-to="home">ğŸ  í™ˆ/ìŠ¬ë¼ì´ë“œ</a>
        <a href="#" class="side-item" data-to="ann">ğŸ“Œ ê³µì§€ì‚¬í•­</a>
        <a href="#" class="side-item" data-to="sched">ğŸ—ºï¸ ì¼ì •</a>
        <a href="#" class="side-item" data-to="visit">ğŸ“ ë°©ë¬¸ì§€</a>
        <a href="#" class="side-item" data-to="meeting">ğŸ“ ì§‘í•© ì¥ì†Œ</a> <!-- âœ… ì¶”ê°€ -->
        <a href="#" class="side-item" data-to="poll">ğŸ—³ï¸ ì„¤ë¬¸</a>
        <hr style="border:none;border-top:1px solid var(--line);margin:8px 0">
        <button class="btn secondary" id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
      </aside>
      <div class="admin-panel">

        <!-- âœ… ì§‘í•© ì¥ì†Œ ê´€ë¦¬ -->
<div class="card" data-id="meeting" style="display:none">
  <h3>ì§‘í•© ì¥ì†Œ</h3>
  <div class="action-row">
    <input id="mtAddress" class="input" placeholder="ì£¼ì†Œ ë˜ëŠ” ì¥ì†Œëª…">
    <select id="mtProvider" class="input">
      <option value="google">Google ì§€ë„</option>
      <option value="naver">Naver ì§€ë„</option>
      <option value="kakao">Kakao ì§€ë„</option>
    </select>
  </div>
  <div class="action-row">
    <input id="mtQuery" class="input" placeholder="ì§€ë„ ê²€ìƒ‰ì–´ (ì˜ˆ: ê²½ê¸° ê´‘ì£¼ì‹œ ë„ì²™ë©´)">
  </div>
  <div class="action-row">
    <input id="mtEmbed" class="input" placeholder="ì„ë² ë“œ URL (ì„ íƒ)">
  </div>
  <div class="action-row">
    <button class="btn" id="btnSaveMeeting">ì €ì¥</button>
  </div>
</div>


        <div class="card" data-id="home">
          <h3>í™ˆ ìŠ¬ë¼ì´ë“œ</h3>
          <div class="action-row"><input id="hsCap" class="input" placeholder="ìº¡ì…˜(ì„ íƒ)"><input id="hsFile" type="file" accept="image/*" class="input" multiple><button class="btn" id="btnUploadHS">ì—…ë¡œë“œ</button></div>
          <div id="hsList" class="list"></div>
        </div>

        <div class="card" data-id="ann" style="display:none">
          <h3>ê³µì§€ì‚¬í•­</h3>
          <div class="action-row"><button class="btn" id="btnAddNotice">+ ê³µì§€ ì¶”ê°€</button></div>
          <table class="table"><thead><tr><th>ì œëª©</th><th>ë‚ ì§œ</th><th>ë‚´ìš©</th><th></th></tr></thead><tbody id="annBody"></tbody></table>
          <div class="action-row"><button class="btn" id="btnSaveAnn">ì €ì¥</button></div>
        </div>

        <div class="card" data-id="sched" style="display:none">
          <h3>ì¼ì •</h3>
          <div class="action-row"><input id="scTitle" class="input" placeholder="ë©”ì¸ ì œëª©(ì˜ˆ: ë‹¹ì¼ ì½”ìŠ¤)"><input id="scDate" class="input" placeholder="ì¼ì(YYYY-MM-DD)"><input id="scDayStart" class="input" placeholder="ì‹œì‘(HH:MM)"><input id="scDayEnd" class="input" placeholder="ì¢…ë£Œ(HH:MM)"><button class="btn secondary" id="btnSaveScMeta">ë©”íƒ€ ì €ì¥</button></div>
          <div class="action-row"><button class="btn" id="btnAddItem">+ í•­ëª© ì¶”ê°€</button></div>
          <table class="table"><thead><tr><th>ì‹œì‘</th><th>ì¢…ë£Œ</th><th>í™œë™</th><th>ì¥ì†Œ</th><th></th></tr></thead><tbody id="scTbody"></tbody></table>
          <div class="action-row"><button class="btn" id="btnSaveItems">ì €ì¥</button></div>
        </div>

        <div class="card" data-id="visit" style="display:none">
          <h3>ë°©ë¬¸ì§€</h3>
          <div class="action-row"><button class="btn" id="btnNewVisit">+ ë°©ë¬¸ì§€ ì¶”ê°€</button></div>
          <div id="visitList" class="list"></div>
        </div>

        <div class="card" data-id="poll" style="display:none">
          <h3>ì„¤ë¬¸</h3>
          <div class="action-row"><input id="plQuestion" class="input" placeholder="ì§ˆë¬¸"><select id="plMultiple" class="input"><option value="false">ë‹¨ì¼ì„ íƒ</option><option value="true">ë³µìˆ˜ì„ íƒ</option></select><input id="plDeadline" class="input" placeholder="ë§ˆê°ì¼(YYYY-MM-DD)"><input id="plOpts" class="input" placeholder="ì˜µì…˜ë“¤(ì‰¼í‘œêµ¬ë¶„)"><button class="btn" id="btnAddPoll">ì„¤ë¬¸ ìƒì„±</button></div>
          <div id="pollList" class="list"></div>
        </div>

      </div>
    </div>
  </section>
</main>
<nav class="navbar"><div class="navbar-inner">
  <a href="index.html">í™ˆ</a><a href="schedule.html">ì¼ì •</a><a href="visits.html">ë°©ë¬¸ì§€</a><a href="survey.html">ì„¤ë¬¸</a><a href="admin.html">ê´€ë¦¬ì</a>
</div></nav>

<script type="module">
import { supabase } from './assets/js/supabase.js';
import { qs, qsa, safeFileName } from './assets/js/ui.js';

function navTo(id){ qsa('.side-item').forEach(a=>a.classList.toggle('active', a.getAttribute('data-to')===id)); qsa('[data-id]').forEach(p=>p.style.display=(p.getAttribute('data-id')===id?'block':'none')); }
async function isAdmin(){
  const { data:{ user } } = await supabase.auth.getUser();
  if(!user) return false;
  const prof = await supabase.from('profiles').select('is_admin').eq('id', user.id).maybeSingle();
  return !!(prof.data && prof.data.is_admin);
}
// --- ì§‘í•© ì¥ì†Œ ê´€ë¦¬ ---
async function loadMeeting(){
  const res = await supabase.from('settings').select('value').eq('key','meeting').maybeSingle();
  const val = res.data?.value || null;
  qs('#mtAddress').value = val?.address || '';
  qs('#mtProvider').value = val?.provider || 'google';
  qs('#mtQuery').value = val?.query || '';
  qs('#mtEmbed').value = val?.embed_url || '';
}

qs('#btnSaveMeeting').addEventListener('click', async ()=>{
  const value = {
    address: qs('#mtAddress').value.trim(),
    provider: qs('#mtProvider').value,
    query: qs('#mtQuery').value.trim(),
    embed_url: qs('#mtEmbed').value.trim()
  };
  const { error } = await supabase.from('settings').upsert({ key: 'meeting', value });
  if(error) return alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
  alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
});

async function refreshUI(){
  const ok = await isAdmin();
  qs('#loginView').style.display = ok? 'none':'block';
  qs('#adminApp').style.display  = ok? 'block':'none';
  if(ok){ navTo('home'); loadHome(); loadAnn(); loadSched(); loadVisits(); loadPolls(); loadMeeting(); }
}

qs('#loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  qs('#loginError').textContent = '';
  const email=qs('#email').value.trim(), pw=qs('#pw').value;
  const { error } = await supabase.auth.signInWithPassword({ email, password: pw });
  if(error){ console.error(error); qs('#loginError').textContent = error.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨'; return; }
  await refreshUI();
});
qs('#btnLogout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); location.reload(); });
qsa('.side-item').forEach(a=>a.addEventListener('click',e=>{ e.preventDefault(); navTo(a.getAttribute('data-to')); }));

// --- í™ˆ ìŠ¬ë¼ì´ë“œ ---
async function loadHome(){
  const { data } = await supabase.from('home_slides').select('*').order('sort',{ascending:true}).order('created_at',{ascending:false});
  const list=qs('#hsList'); list.innerHTML='';
  (data||[]).forEach(s=>{
    const row=document.createElement('div'); row.className='card';
    row.innerHTML = `<div class='action-row'><input class='input cap' data-id='${s.id}' value='${s.caption||''}'><input class='input' value='${s.path||''}' disabled><button class='btn secondary' data-save='${s.id}'>ìˆ˜ì •</button><button class='btn danger' data-del='${s.id}'>ì‚­ì œ</button></div>`;
    list.appendChild(row);
  });
  list.onclick = async (e)=>{
    const del=e.target.closest('[data-del]'), save=e.target.closest('[data-save]');
    if(save){ const id=save.getAttribute('data-save'); const cap=list.querySelector(`input.cap[data-id="${id}"]`).value; await supabase.from('home_slides').update({ caption: cap }).eq('id', id); alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
    if(del){ const id=del.getAttribute('data-del'); if(confirm('ì‚­ì œ?')){ await supabase.from('home_slides').delete().eq('id', id); loadHome(); } }
  };
}
qs('#btnUploadHS').addEventListener('click', async ()=>{
  const files=Array.from(qs('#hsFile').files||[]); if(!files.length) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”');
  for(const f of files){
    const safe=safeFileName(f.name); const name=Date.now()+'_'+safe; const path='slides/'+name;
    const up=await supabase.storage.from('images').upload(path, f);
    if(up.error) return alert('ì—…ë¡œë“œ ì‹¤íŒ¨: '+up.error.message);
    const pub = supabase.storage.from('images').getPublicUrl(path).data.publicUrl;
    await supabase.from('home_slides').insert({ url: pub, path, caption: qs('#hsCap').value.trim() });
  }
  qs('#hsFile').value=''; qs('#hsCap').value=''; loadHome();
});

// --- ê³µì§€ ---
async function loadAnn(){
  const { data } = await supabase.from('notices').select('*').order('created_at',{ascending:false});
  const tb=qs('#annBody'); tb.innerHTML='';
  (data||[]).forEach(n=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><input class='input a-title' data-id='${n.id}' value='${n.title||''}'></td><td><input class='input a-date' data-id='${n.id}' value='${(n.created_at||'').slice(0,10)}'></td><td><input class='input a-body' data-id='${n.id}' value='${n.body||''}'></td><td><button class='btn danger' data-del='${n.id}'>X</button></td>`; tb.appendChild(tr); });
  qs('#btnAddNotice').onclick = ()=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><input class='input a-title'></td><td><input class='input a-date' placeholder='YYYY-MM-DD'></td><td><input class='input a-body'></td><td><button class='btn danger' data-del=''>X</button></td>`; tb.prepend(tr); };
  qs('#btnSaveAnn').onclick = async ()=>{
    const newRows = qsa('tr', tb).filter(tr=>!tr.querySelector('.a-title').dataset.id);
    for(const tr of newRows){
      const t=tr.querySelector('.a-title').value.trim();
      const d=tr.querySelector('.a-date').value.trim();
      const b=tr.querySelector('.a-body').value.trim();
      await supabase.from('notices').insert({ title:t, body:b, created_at: d? new Date(d).toISOString(): undefined });
    }
    const rows = qsa('tr', tb).filter(tr=>tr.querySelector('.a-title').dataset.id);
    for(const tr of rows){
      const id=tr.querySelector('.a-title').dataset.id;
      const t=tr.querySelector('.a-title').value.trim();
      const d=tr.querySelector('.a-date').value.trim();
      const b=tr.querySelector('.a-body').value.trim();
      await supabase.from('notices').update({ title:t, body:b, created_at: d? new Date(d).toISOString(): undefined }).eq('id', id);
    }
    alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); loadAnn();
  };
  tb.onclick = async (e)=>{ const x=e.target.closest('[data-del]'); if(!x)return; const id=x.getAttribute('data-del'); if(id){ await supabase.from('notices').delete().eq('id', id); x.closest('tr').remove(); } else x.closest('tr').remove(); };
}

// --- ì¼ì • ---
function trItem(it){ return `<tr data-id='${it.id||""}'><td><input class='input st' placeholder='HH:MM' value='${it.start_time||it.time||""}'></td><td><input class='input et' placeholder='HH:MM' value='${it.end_time||""}'></td><td><input class='input act' value='${it.activity||""}'></td><td><input class='input plc' value='${it.place||""}'></td><td><button class='btn danger' data-del='row'>X</button></td></tr>`; }
async function loadSched(){
  const meta = await supabase.from('settings').select('value').eq('key','schedule_day').maybeSingle(); const mv=meta.data?.value||{};
  qs('#scTitle').value=mv.title||''; qs('#scDate').value=mv.date||''; qs('#scDayStart').value=mv.day_start||''; qs('#scDayEnd').value=mv.day_end||'';
  const { data } = await supabase.from('schedules').select('*');
  const rows=(data||[]).slice().sort((x,y)=>((x.start_time||x.time||'').localeCompare(y.start_time||y.time||'')));
  const tb=qs('#scTbody'); tb.innerHTML = rows.map(trItem).join('');
}
qs('#btnSaveScMeta').addEventListener('click', async ()=>{
  const value = { title:qs('#scTitle').value.trim(), date:qs('#scDate').value.trim(), day_start:qs('#scDayStart').value.trim(), day_end:qs('#scDayEnd').value.trim() };
  await supabase.from('settings').upsert({ key:'schedule_day', value });
  alert('ë©”íƒ€ ì €ì¥'); 
});
qs('#btnAddItem').addEventListener('click', ()=>{ qs('#scTbody').insertAdjacentHTML('afterbegin', trItem({})); });
qs('#scTbody').addEventListener('click', async (e)=>{
  const del=e.target.closest('[data-del="row"]'); if(!del) return;
  const tr = del.closest('tr'); const id=tr.getAttribute('data-id'); if(id) await supabase.from('schedules').delete().eq('id', id); tr.remove();
});
qs('#btnSaveItems').addEventListener('click', async ()=>{
  const rows = qsa('#scTbody tr');
  for(const tr of rows){
    const id=tr.getAttribute('data-id'); const st=tr.querySelector('.st').value.trim(); const et=tr.querySelector('.et').value.trim(); const act=tr.querySelector('.act').value.trim(); const plc=tr.querySelector('.plc').value.trim();
    const payload = { start_time:st, end_time:et, activity:act, place:plc, time:st };
    if(id) await supabase.from('schedules').update(payload).eq('id', id);
    else await supabase.from('schedules').insert(payload);
  }
  alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); loadSched();
});

// --- ë°©ë¬¸ì§€ ---
function visitCard(v, imgs){
  const listImgs = (imgs||[]).map(im=>`<div class='card'><img class='thumb' src='${im.url || (supabase.storage.from("images").getPublicUrl(im.path).data.publicUrl)}'><div class='action-row'><button class='btn danger' data-imgdel='${im.id}' data-visit='${v.id}'>ì‚­ì œ</button></div></div>`).join('');
  return `<div class='card' data-vid='${v.id}'>
    <div class='action-row'><input class='input v-title' value='${v.title||""}'><input class='input v-sum' value='${v.summary||""}'></div>
    <textarea class='input v-body'>${v.body||""}</textarea>
    <input class='input v-q' value='${v.map_query||""}' placeholder='ì§€ë„ ê²€ìƒ‰ì–´'>
    <div class='action-row'><button class='btn secondary' data-save='${v.id}'>ìˆ˜ì •</button><button class='btn danger' data-del='${v.id}'>ë°©ë¬¸ì§€ ì‚­ì œ</button></div>
    <div class='action-row'><input type='file' accept='image/*' data-f='${v.id}'><button class='btn secondary' data-up='${v.id}'>ì´ë¯¸ì§€ ì—…ë¡œë“œ</button><a class='btn' href='visit.html?id=${encodeURIComponent(v.id)}' target='_blank'>ìƒì„¸ ë¯¸ë¦¬ë³´ê¸°</a></div>
    <div class='grid'>${listImgs}</div>
  </div>`;
}
async function loadVisits(){
  const { data } = await supabase.from('visits').select('*').order('created_at',{ascending:false});
  const list = qs('#visitList');
  list.innerHTML = '';

  for(const v of (data||[])){
    const { data: imgs } = await supabase.from('visit_images').select('*').eq('visit_id', v.id).order('created_at',{ascending:true});
    const div = document.createElement('div');
    div.classList.add('card');
    div.setAttribute('data-vid', v.id);
    div.innerHTML = `
      <div class='action-row'>
        <input class='input v-title' value='${v.title||""}' placeholder='ì œëª©'>
        <input class='input v-sum' value='${v.summary||""}' placeholder='ìš”ì•½'>
      </div>
      <textarea class='input v-body' placeholder='ë³¸ë¬¸'>${v.body||""}</textarea>
      <input class='input v-q' value='${v.map_query||""}' placeholder='ì§€ë„ ê²€ìƒ‰ì–´'>
      <div class='action-row'>
        <button class='btn secondary' data-save='${v.id}'>ìˆ˜ì •</button>
        <button class='btn danger' data-del='${v.id}'>ë°©ë¬¸ì§€ ì‚­ì œ</button>
      </div>
      <div class='action-row'>
        <input type='file' accept='image/*' id='file_${v.id}'>
        <button class='btn secondary' data-up='${v.id}'>ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
        <a class='btn' href='visit.html?id=${encodeURIComponent(v.id)}' target='_blank'>ìƒì„¸ ë¯¸ë¦¬ë³´ê¸°</a>
      </div>
      <div class='grid' id='imgs_${v.id}'>
        ${(imgs||[]).map(im => `
          <div class='card'>
            <img class='thumb' src='${im.url || supabase.storage.from("images").getPublicUrl(im.path).data.publicUrl}' alt=''>
            <div class='action-row'>
              <button class='btn danger' data-imgdel='${im.id}' data-visit='${v.id}'>ì‚­ì œ</button>
            </div>
          </div>`).join('')}
      </div>
    `;
    list.appendChild(div);

    // ì—…ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë‹¨ì¼ ë“±ë¡
    const fileInput = div.querySelector(`#file_${v.id}`);
    const uploadBtn = div.querySelector(`[data-up='${v.id}']`);
    uploadBtn.onclick = async ()=>{
      fileInput.click();
    };
    fileInput.onchange = async ()=>{
      const file = fileInput.files[0];
      if(!file) return;
      const safe = safeFileName(file.name);
      const name = Date.now() + '_' + safe;
      const path = 'visits/' + name;
      const up = await supabase.storage.from('images').upload(path, file);
      if(up.error) return alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + up.error.message);
      const pub = supabase.storage.from('images').getPublicUrl(path).data.publicUrl;
      await supabase.from('visit_images').insert({ visit_id: v.id, url: pub, path });
      alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ');
      loadVisits(); // âœ… ì—…ë¡œë“œ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    };
  }

  // ì‚­ì œ/ìˆ˜ì • ì´ë²¤íŠ¸ (ë¦¬ìŠ¤íŠ¸ ì „ì²´ìš©)
  list.onclick = async (e)=>{
    const delVisit = e.target.closest('[data-del]');
    const saveVisit = e.target.closest('[data-save]');
    const delImg = e.target.closest('[data-imgdel]');

    if(saveVisit){
      const id = saveVisit.getAttribute('data-save');
      const box = saveVisit.closest('[data-vid]');
      const title = box.querySelector('.v-title').value.trim();
      const summary = box.querySelector('.v-sum').value.trim();
      const body = box.querySelector('.v-body').value.trim();
      const map_query = box.querySelector('.v-q').value.trim();
      await supabase.from('visits').update({ title, summary, body, map_query }).eq('id', id);
      alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    if(delVisit){
      const id = delVisit.getAttribute('data-del');
      if(confirm('ë°©ë¬¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
        await supabase.from('visits').delete().eq('id', id);
        loadVisits();
      }
    }

    if(delImg){
      const iid = delImg.getAttribute('data-imgdel');
      if(confirm('ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
        await supabase.from('visit_images').delete().eq('id', iid);
        loadVisits();
      }
    }
  };
}

qs('#btnNewVisit').addEventListener('click', async ()=>{
  const ins = await supabase.from('visits').insert({ title:'ì œëª©', summary:'ìš”ì•½', body:'ë³¸ë¬¸', map_query:'' }).select();
  if(ins.error) return alert(ins.error.message);
  loadVisits();
});

// --- ì„¤ë¬¸ (ê´€ë¦¬ì ê²°ê³¼ í¬í•¨) ---
async function loadPolls(){
  const { data } = await supabase.from('polls').select('*').order('created_at',{ascending:false});
  const box = qs('#pollList'); box.innerHTML = '';
  for(const p of (data||[])){
    const { data: opts } = await supabase.from('poll_options').select('*').eq('poll_id', p.id).order('id',{ascending:true});
    const { data: resps } = await supabase.from('poll_responses').select('option_id').eq('poll_id', p.id);
    const counts={}; (resps||[]).forEach(r=>{ counts[r.option_id]=(counts[r.option_id]||0)+1; });
    const total = (resps||[]).length;
    const rows = (opts||[]).map((o,i)=>{
      const c=counts[o.id]||0;
      const label=o.option_text||o.label||'';
      const pct= total? Math.round(c*100/total):0;
      return `<tr><td>${i+1}. ${label}</td><td style='text-align:right'>${c}í‘œ</td><td style='width:120px'><div style="background:#ecfbf8;height:8px;border-radius:6px;overflow:hidden"><div style="height:8px;background:#63d3c6;width:${pct}%"></div></div></td><td style='text-align:right'>${pct}%</td></tr>`;
    }).join('');
    const el=document.createElement('div'); el.className='card';
    el.innerHTML = `
      <h4><input class='input q' value="${p.question||''}"></h4>
      <div class='small'>
        ë§ˆê°: <input class='input d' style='width:140px' value='${p.deadline||''}'>
        | ë³µìˆ˜ì„ íƒ:
        <select class='input m' style='width:120px'>
          <option value='false' ${p.multiple?'':'selected'}>ì•„ë‹ˆì˜¤</option>
          <option value='true' ${p.multiple?'selected':''}>ì˜ˆ</option>
        </select>
      </div>
      <div class='action-row'>
        <button class='btn secondary' data-savp='${p.id}'>ìˆ˜ì •</button>
        <button class='btn danger' data-delp='${p.id}'>ì„¤ë¬¸ ì‚­ì œ</button>
      </div>
      <table class='table' style='margin-top:8px'>
        <thead><tr><th>ë³´ê¸°</th><th>ë“í‘œ</th><th colspan='2'>ë¹„ìœ¨</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
    box.appendChild(el);

    el.onclick = async (e)=>{
      const sv=e.target.closest('[data-savp]');
      const dl=e.target.closest('[data-delp]');

      if(sv){
        const q=el.querySelector('.q').value;
        const m=el.querySelector('.m').value==='true';
        const d=el.querySelector('.d').value.trim();
        await supabase.from('polls').update({ question:q, multiple:m, deadline:d||null }).eq('id', sv.getAttribute('data-savp'));
        alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      if(dl){
        if(confirm('ì„¤ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì˜µì…˜/ì‘ë‹µ í¬í•¨)')){
          const pid = dl.getAttribute('data-delp');
          const { data, error } = await supabase.rpc('admin_delete_poll', { p_poll: pid });
          if(error){
            console.error('ì‚­ì œ ì‹¤íŒ¨:', error.message);
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
          } else {
            alert('ì‚­ì œ ì™„ë£Œ');
            loadPolls();
          }
        }
      }
    };  // âœ… ë‹«í˜
  }
}  // âœ… loadPolls ë‹«í˜

// --- ì„¤ë¬¸ ì¶”ê°€ ---
qs('#btnAddPoll').addEventListener('click', async ()=>{
  const q = qs('#plQuestion').value.trim();
  const m = qs('#plMultiple').value === 'true';
  const d = qs('#plDeadline').value.trim();
  const opts = qs('#plOpts').value.split(',').map(s => s.trim()).filter(Boolean);

  const ins = await supabase.from('polls')
    .insert({ question:q, multiple:m, deadline:d||null, is_active:true })
    .select();

  if(ins.error) {
    alert('ì„¤ë¬¸ ìƒì„± ì‹¤íŒ¨: ' + ins.error.message);
    return;
  }

  const pid = ins.data?.[0]?.id;
  if(!pid) return;

  if(opts.length){
    await supabase.from('poll_options')
      .insert(opts.map(t => ({ poll_id: pid, option_text: t })));
  }

  qs('#plQuestion').value = '';
  qs('#plOpts').value = '';
  alert('ì„¤ë¬¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
  loadPolls();
});  // âœ… ë‹«í˜

// --- ì´ˆê¸°í™” ---
refreshUI();
</script>
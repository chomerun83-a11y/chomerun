<!doctype html><html lang="ko"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>설문</title>
<link rel="stylesheet" href="assets/css/style.css"></head><body>
<header class="header"><div class="header-inner"><div class="brand"><div class="title">설문</div></div></div></header>
<main class="container">
  <section class="section" id="pollWrap"></section>
</main>
<nav class="navbar"><div class="navbar-inner">
  <a href="index.html">홈</a><a href="schedule.html">일정</a><a href="visits.html">방문지</a><a href="survey.html">설문</a><a href="admin.html">관리자</a>
</div></nav>
<script type="module">
import { supabase } from './assets/js/supabase.js';
import { qs, qsa } from './assets/js/ui.js';

async function loadPolls(){
  const { data: polls } = await supabase.from('polls').select('*').eq('is_active', true).order('created_at',{ascending:false});
  const wrap=qs('#pollWrap'); wrap.innerHTML='';
  if(!polls || !polls.length){ wrap.innerHTML='<div class="card small">진행중인 설문이 없습니다.</div>'; return; }
  for(const p of polls){
    const { data: opts } = await supabase.from('poll_options').select('*').eq('poll_id', p.id).order('id',{ascending:true});
    const multiple = !!p.multiple;
    const optsHtml = (opts||[]).map(o=>`<label class="opt"><input type="${multiple?'checkbox':'radio'}" name="poll_${p.id}" value="${o.id}"> ${o.option_text||o.label||''}</label>`).join('');
    const el=document.createElement('div'); el.className='card';
    el.innerHTML = `<div style="font-weight:700">${p.question}</div>${p.deadline?`<div class="small">마감: ${p.deadline}</div>`:''}
      <div style="margin-top:6px">${optsHtml}</div><div class="action-row"><button class="btn" data-vote="${p.id}">투표하기</button></div>`;
    wrap.appendChild(el);
  }
  wrap.onclick = async (e)=>{
    const b = e.target.closest('[data-vote]'); if(!b) return;
    const pid = b.getAttribute('data-vote');
    const inputs = qsa(`input[name="poll_${pid}"]`, wrap);
    const sel = inputs.filter(i => i.checked).map(i => Number(i.value) || i.value);
    if (!sel.length) { alert('항목을 선택하세요.'); return; }
    try{
      const { error } = await supabase.rpc('poll_vote', { p_poll: pid, p_option_ids: sel });
      if(error) throw error;
    }catch(_){
      const rows = sel.map(oid=>({ poll_id: pid, option_id: oid }));
      const { error } = await supabase.from('poll_responses').insert(rows);
      if(error) return alert('투표 오류: '+error.message);
    }
    alert('투표되었습니다. 결과는 관리자 페이지에서 확인하세요.');
  };
}
loadPolls();
</script>
</body></html>